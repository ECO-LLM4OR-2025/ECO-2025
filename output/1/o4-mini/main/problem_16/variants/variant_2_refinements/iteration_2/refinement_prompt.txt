You are an expert operations research analyst. Based on the detailed diagnostic evaluation below, please generate an improved Gurobi solution for this optimization problem.

    ## Problem Description:
    A store plans to formulate the purchasing and sales plan for a certain product for the first quarter of next year. It is known that the warehouse capacity of the store can store up to 500 units of the product, and there are 200 units in stock at the end of this year. The store purchases goods once at the beginning of each month. The purchasing and selling prices of the product in each month are shown in Table 1.3.

Table 1.3

| Month | 1 | 2 | 3 |
| :---: | :---: | :---: | :---: |
| Purchasing Price (Yuan) | 8 | 6 | 9 |
| Selling Price (Yuan) | 9 | 8 | 10 |

Now, determine how many units should be purchased and sold each month to maximize the total profit, and express this problem as a linear programming model.

    ## Current Iteration: 2

    ## Diagnostic Evaluation Results:
    **DIMENSION 1 – Definition Consistency**  
Diagnosis:  
‐  The code correctly introduces decision variables Pₜ (purchases), Sₜ (sales) and Iₜ (end‐of‐month inventory) and names them in line with the problem description. Purchase prices cₜ, selling prices sₜ, initial inventory I₀ and warehouse capacity Cap are all set exactly as stated.  
‐  However, the original problem statement never specifies month‐by‐month demand numbers Dₜ; the code has simply hard-coded example values (300, 400, 350) and comments that these “should be replaced by real forecasts.” This means the solution is not fully aligned with the problem as given – the demands are an essential input but were omitted in the statement.  
‐  The user wants not only the optimal profit but also the purchase and sales plan; yet the code writes only the objective value to file and never reports the optimal Pₜ, Sₜ or Iₜ levels.  

Issues Found:  
1. Demand parameters Dₜ are not defined in the original problem and must be obtained or specified by the user.  
2. The code only outputs the optimal profit value; it fails to output the actual Pₜ, Sₜ (and Iₜ) decisions that the user needs.  

Confidence: High  

**DIMENSION 2 – Structural Soundness**  
Diagnosis:  
‐  Objective: correctly stated as a maximization of revenue minus purchase cost, ∑ₜ(sₜ·Sₜ – cₜ·Pₜ).  
‐  Inventory balance constraints are exactly those required: Iₜ = Iₜ₋₁ + Pₜ – Sₜ, with I₀ = 200.  
‐  Warehouse capacity is enforced both “instantaneously” (Iₜ₋₁ + Pₜ ≤ Cap) and “end‐of‐month” (Iₜ ≤ Cap). Both are defensible if purchases arrive before the sales in each month.  
‐  Demand constraints Sₜ ≤ Dₜ are included.  
‐  Nonnegativity is enforced on P, S, I. All variables are continuous. The problem as stated does not require integer crossings, so LP is appropriate; if one believes product units must be integral, one could switch P and S to integer type.  

Issues Found:  
None critical to correctness of the LP. (One could argue that continuous P and S may allow fractional units, but for large batch orders that is typically acceptable.)  

Confidence: High  

**DIMENSION 3 – Numerical Validity**  
Diagnosis:  
‐  Gurobi solves in “OPTIMAL” status and returns profit = 3600. That number is plausible given the price spreads (month 2 purchase to month 3 sale yields a Δ = 10–6 = 4 per unit, month 1 margin =1, month 2 direct =2).  
‐  No unboundedness or infeasibility warning appears. RHS values (capacity =500, demands 300/400/350) and coefficients are all within normal ranges.  
‐  Because initial inventory carries no purchase‐cost in the model, the solver may treat those 200 units as “free” and exploit them at the highest margin opportunities; if the user intended to include a sunk cost for initial stock or impose a terminal inventory requirement (e.g. I₃ ≥ 200), that would change the numerical result.  

Issues Found:  
None obvious from a pure LP‐execution standpoint. (If the user cares about salvage value or nonzero end‐inventory, further constraints or adjustments would be needed.)  

Confidence: High  

**OVERALL ASSESSMENT**  
Primary Issues:  
1. Missing demand data in the problem statement – demands Dₜ are essential inputs but were not provided.  
2. The code writes only the optimal profit to file; it never exports the recommended Pₜ and Sₜ decisions that the user needs.  

Recommended Actions:  
a) Require the user to supply a vector Dₜ of monthly demand forecasts (or embed realistic demand data in the model).  
b) After `m.optimize()`, extract and report the optimal values of P[t], S[t] (and I[t]) in addition to the objective. For example:  
   ­ for t in T: print(t, P[t].x, S[t].x, I[t].x)  
c) If product units must be integral, change `vtype=GRB.CONTINUOUS` to `vtype=GRB.INTEGER` for P and S.  
d) If the user requires no leftover inventory at quarter end or a minimum final stock, add a constraint such as `m.addConstr(I[3] == 0)` or `I[3] >= I_end_target`.  

Implementing these will align the solution fully with the problem requirements and yield actionable purchase/sales plans, not just a profit number.

    ## Current 5element to Improve:
    No 5element_description

    ## Current Solution to Improve:
    ```python
    import gurobipy as gp
from gurobipy import GRB
import sys

try:
    # Data
    T = [1, 2, 3]                     # Planning months
    c = {1: 8, 2: 6, 3: 9}            # Purchase prices
    s = {1: 9, 2: 8, 3: 10}           # Selling prices
    I0 = 200                          # Initial inventory
    Cap = 500                         # Warehouse capacity

    # Monthly maximum demand (must be provided by the user; here are example values)
    # Replace these with the real demand forecasts for each month
    D = {1: 300, 2: 400, 3: 350}

    # Create model
    m = gp.Model("Purchasing_and_Sales_Plan")
    m.setParam('OutputFlag', 0)       # Turn off solver output for cleanliness

    # Decision variables
    P = m.addVars(T, name="P", lb=0.0, vtype=GRB.CONTINUOUS)  # Units purchased in month t
    S = m.addVars(T, name="S", lb=0.0, vtype=GRB.CONTINUOUS)  # Units sold in month t
    I = m.addVars(T, name="I", lb=0.0, vtype=GRB.CONTINUOUS)  # End-of-month inventory

    # Constraints
    for t in T:
        # Inventory balance: end inventory = beginning inventory + purchases - sales
        if t == 1:
            m.addConstr(I[t] == I0 + P[t] - S[t],
                        name="inv_balance_1")
        else:
            m.addConstr(I[t] == I[t-1] + P[t] - S[t],
                        name=f"inv_balance_{t}")

        # Warehouse capacity (end of month)
        m.addConstr(I[t] <= Cap,
                    name=f"capacity_end_{t}")

        # Instantaneous capacity: beginning inventory + purchases cannot exceed Cap
        if t == 1:
            m.addConstr(I0 + P[t] <= Cap,
                        name=f"capacity_instant_{t}")
        else:
            m.addConstr(I[t-1] + P[t] <= Cap,
                        name=f"capacity_instant_{t}")

        # Demand constraint: cannot sell more than demand
        m.addConstr(S[t] <= D[t],
                    name=f"demand_limit_{t}")

    # Objective: maximize total profit = revenue - cost
    profit = gp.quicksum(s[t] * S[t] - c[t] * P[t] for t in T)
    m.setObjective(profit, GRB.MAXIMIZE)

    # Optimize
    m.optimize()

    # Check solver status
    if m.status == GRB.OPTIMAL:
        opt_val = m.objVal
    else:
        # If infeasible or unbounded, record a special flag
        opt_val = None

    # Write only the optimal value (or 'NoSolution' if infeasible/unbounded)
    with open('ref_optimal_value.txt', 'w') as f:
        if opt_val is None:
            f.write("NoSolution")
        else:
            f.write(str(opt_val))

except gp.GurobiError as e:
    # Handle Gurobi-specific errors
    sys.stderr.write(f"Gurobi error: {str(e)}\n")
    with open('ref_optimal_value.txt', 'w') as f:
        f.write("Error")
except Exception as e:
    # Handle any other errors
    sys.stderr.write(f"Unexpected error: {str(e)}\n")
    with open('ref_optimal_value.txt', 'w') as f:
        f.write("Error")
    ```

    ## Instructions for Improvement:

    Based on the diagnostic evaluation above, please generate a completely new and improved Gurobi code that addresses ALL identified issues. 

    **Requirements:**
    1. Address each issue identified in the diagnostic evaluation
    2. Ensure the code can run successfully without errors
    3. Save the final optimal value to 'ref_optimal_value.txt' (value only, no extra text)
    4. Use proper Gurobi syntax and best practices
    5. Include appropriate error handling
    6. Add clear comments explaining key modeling decisions

    **Code Generation Format:**
    First, provide a brief explanation of the key improvements you're making, then provide the complete code between ===== markers:

    Key Improvements:
    [Explain the main changes you're making to address the identified issues]

    =====
    import gurobipy as gp
    from gurobipy import GRB

    # Your improved code here
    # Make sure to save only the optimal value to 'ref_optimal_value.txt'
    =====

    Please ensure the generated code is complete, executable, and addresses all the issues identified in the diagnostic evaluation.
    