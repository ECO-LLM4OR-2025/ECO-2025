You are an expert operations research analyst. Based on the detailed diagnostic evaluation below, please generate an improved Gurobi solution for this optimization problem.

    ## Problem Description:
    A store plans to formulate the purchasing and sales plan for a certain product for the first quarter of next year. It is known that the warehouse capacity of the store can store up to 500 units of the product, and there are 200 units in stock at the end of this year. The store purchases goods once at the beginning of each month. The purchasing and selling prices of the product in each month are shown in Table 1.3.

Table 1.3

| Month | 1 | 2 | 3 |
| :---: | :---: | :---: | :---: |
| Purchasing Price (Yuan) | 8 | 6 | 9 |
| Selling Price (Yuan) | 9 | 8 | 10 |

Now, determine how many units should be purchased and sold each month to maximize the total profit, and express this problem as a linear programming model.

    ## Current Iteration: 1

    ## Diagnostic Evaluation Results:
    **DIMENSION 1 – Definition Consistency**  
Diagnosis:  
• Sets, parameters and decision variables (Pₜ, Sₜ, Iₜ) are all named consistently with the description.  
• Purchase prices cₜ={8,6,9}, selling prices sₜ={9,8,10}, initial inventory I₀=200 and capacity Cap=500 match exactly.  
• The only “entity” missing is any representation of market demand or an upper bound on sales; the problem text never specifies how many units can actually be sold in a month.  

Issues Found:  
1. Missing demand (or maximum‐sales) parameter Dₜ and constraint Sₜ ≤ Dₜ (the model currently allows selling unlimited units).  

Confidence: High  

**DIMENSION 2 – Structural Soundness**  
Diagnosis:  
• Objective is correctly set to maximize total profit ∑(sₜ·Sₜ – cₜ·Pₜ).  
• Inventory balance constraints Iₜ = Iₜ₋₁ + Pₜ – Sₜ are correct for end‐of‐period stock.  
• Capacity constraint Iₜ ≤ 500 on end‐of‐month inventory is syntactically correct but does not prevent “buy then sell” in the same period from violating the intuitive warehouse limit at the instant of receipt.  
• All variables are naturally continuous and nonnegative; integer flows are not required here.  

Issues Found:  
1. No sales‐limit or demand constraint → model becomes unbounded when selling price exceeds purchase price.  
2. Warehouse capacity is applied only to Iₜ, not to “inventory-on‐hand + incoming purchases” before sales; this allows violating physical capacity if you instantaneously purchase and then sell.  

Confidence: High  

**DIMENSION 3 – Numerical Validity**  
Diagnosis:  
• Solver returned “Infeasible or unbounded.”  Presolve removed rows and then immediately concluded no bounds on profit.  
• Because you can choose an arbitrarily large P₁, set S₁ = I₀ + P₁ (so I₁ = 0 and capacity holds), each extra unit generates (9–8)=1 Yuan profit, driving the model unbounded.  

Issues Found:  
1. Unbounded profit due to missing upper bound on Sₜ (i.e. no demand constraint).  
2. Missing instantaneous capacity check on Pₜ + Iₜ₋₁ before Sₜ occurs allows arbitrarily large buys followed by same‐period sells.  

Confidence: High  

**OVERALL ASSESSMENT**  
Primary Issues (in order):  
1. No demand constraint → unbounded sales/purchases.  
2. Mis‐specified capacity constraint (should cap Iₜ₋₁+Pₜ, not only Iₜ).  

Recommended Actions:  
• Introduce a parameter Dₜ for monthly maximum demand and add  Sₜ ≤ Dₜ ∀ t.  
• Either  
   – Change warehouse constraint to Iₜ₋₁ + Pₜ ≤ Cap (so you cannot receive more than capacity before selling), or  
   – Enforce a sequencing: split Pₜ and Sₜ into “pre‐sale” and “post‐sale” balances, or tighten the model so that Pₜ ≤ Cap – Iₜ₋₁.  
• If final inventory I₃ must meet a target or incurs holding costs, model that explicitly to avoid end‐of‐horizon anomalies.  

These fixes will restore boundedness and ensure the solution is physically and economically meaningful.

    ## Current 5element to Improve:
    Sets:
T = {1,2,3}  // months in the planning horizon

Variables:
P_t ≥ 0  continuous  // units purchased in month t
S_t ≥ 0  continuous  // units sold in month t
I_t ≥ 0  continuous  // inventory at the end of month t

Parameters:
c_t = {8, 6, 9}      // purchase price in month t
s_t = {9, 8, 10}     // selling price in month t
I_0 = 200            // initial inventory at start of month 1
Cap = 500            // warehouse capacity

Constraints:
1. Inventory balance for each t ∈ T:
   I_t = I_{t-1} + P_t - S_t

2. Capacity limit for each t ∈ T:
   I_t ≤ Cap

3. Nonnegativity:
   P_t ≥ 0, S_t ≥ 0, I_t ≥ 0 ∀ t ∈ T

Objective:
Maximize total profit:
   Maximize ∑_{t∈T} (s_t * S_t − c_t * P_t)

    ## Current Solution to Improve:
    ```python
    import gurobipy as gp
from gurobipy import GRB

# Data
T = [1, 2, 3]
c = {1: 8, 2: 6, 3: 9}    # purchase prices
s = {1: 9, 2: 8, 3: 10}   # selling prices
I0 = 200                  # initial inventory
Cap = 500                 # warehouse capacity

# Model
m = gp.Model("Purchasing_and_Sales_Plan")

# Decision variables
P = m.addVars(T, name="P", lb=0, vtype=GRB.CONTINUOUS)  # purchased units
S = m.addVars(T, name="S", lb=0, vtype=GRB.CONTINUOUS)  # sold units
I = m.addVars(T, name="I", lb=0, vtype=GRB.CONTINUOUS)  # end inventory

# Constraints
# Inventory balance
for t in T:
    if t == 1:
        m.addConstr(I[t] == I0 + P[t] - S[t], name=f"inv_balance_{t}")
    else:
        m.addConstr(I[t] == I[t-1] + P[t] - S[t], name=f"inv_balance_{t}")

# Warehouse capacity
for t in T:
    m.addConstr(I[t] <= Cap, name=f"capacity_{t}")

# Objective: maximize profit
obj = gp.quicksum(s[t] * S[t] - c[t] * P[t] for t in T)
m.setObjective(obj, GRB.MAXIMIZE)

# Solve
m.optimize()

# Write optimal objective value to file
if m.status == GRB.OPTIMAL:
    with open('ref_optimal_value.txt', 'w') as f:
        f.write(str(m.objVal))
else:
    with open('ref_optimal_value.txt', 'w') as f:
        f.write("No optimal solution found.")
    ```

    ## Instructions for Improvement:

    Based on the diagnostic evaluation above, please generate a completely new and improved Gurobi code that addresses ALL identified issues. 

    **Requirements:**
    1. Address each issue identified in the diagnostic evaluation
    2. Ensure the code can run successfully without errors
    3. Save the final optimal value to 'ref_optimal_value.txt' (value only, no extra text)
    4. Use proper Gurobi syntax and best practices
    5. Include appropriate error handling
    6. Add clear comments explaining key modeling decisions

    **Code Generation Format:**
    First, provide a brief explanation of the key improvements you're making, then provide the complete code between ===== markers:

    Key Improvements:
    [Explain the main changes you're making to address the identified issues]

    =====
    import gurobipy as gp
    from gurobipy import GRB

    # Your improved code here
    # Make sure to save only the optimal value to 'ref_optimal_value.txt'
    =====

    Please ensure the generated code is complete, executable, and addresses all the issues identified in the diagnostic evaluation.
    